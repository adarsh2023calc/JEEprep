{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style2.css' %}">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");
    </script>
</head>

<body>

<div class="main-frame">
    <div class="dashboard">

        <!-- Sidebar -->
        <aside class="sidebar">
            <h2 class="logo">Welcome {{ user.username }}</h2>

            <ul class="menu">
                <li id="dashboard" class="active" onclick="ChangeActiveClass('dashboard')">Dashboard</li>
                <li id="content" onclick="ChangeActiveClass('content')">Content</li>
                <li id="analytics" onclick="ChangeActiveClass('analytics')">Analytics</li>
            </ul>

            <div class="bottom">
                <p>Logout</p>
                <div class="dark-mode">
                    <span>Dark Mode</span>
                    <input type="checkbox">
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">

            <!-- Top Bar -->
            <div class="top-bar">
                <input type="text" placeholder="Search here...">
                <img src="https://i.pravatar.cc/40" class="avatar">
            </div>

            <!-- Stats Cards -->
            <div class="cards">
                <div class="card blue">
                    <h3>Aptitude Overall Accuracy</h3>
                    <p id="aptitude-score">--</p>
                </div>

                <div class="card yellow">
                    <h3>Verbals Overall Accuracy</h3>
                    <p id="verbals-score">--</p>
                </div>

                <div class="card purple">
                    <h3>Software Topics Accuracy</h3>
                    <p id="software-score">--</p>
                </div>
            </div>

            <!-- Dynamic Tables Section -->
            <section class="table-section">
                <h2>Recent Activity</h2>
                <!-- Tables will be injected here -->
            </section>

        </main>
    </div>
</div>

<script>
    ChangeActiveClass('dashboard');

    function ChangeActiveClass(listID) {
        ["dashboard", "content", "analytics"].forEach(id => {
            document.getElementById(id).className = id === listID ? "active" : "";
        });

        if (listID === "dashboard") {
            LoadPastAssessments();
        }
    }

    async function LoadPastAssessments() {
    const section = document.querySelector(".table-section");
    section.innerHTML = "<h2>Recent Activity</h2><p>Loading...</p>";

    try {
        const response = await fetch("/api/get_details/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ user_id: "{{ user.username }}" })
        });

        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();

        console.log(data['coding']);
        // Remove loading message
        section.innerHTML = "<h2>Recent Activity</h2>";
        
        // Update score cards
        updateScoreCards();
        
        // Display tables
        displayTables(data, section);
        
    } catch (error) {
        console.error("Error loading assessments:", error);
        section.innerHTML = "<h2>Recent Activity</h2><p>Failed to load data. Please try again.</p>";
    }
}

async function updateScoreCards() {
    const scores = await fetch("/api/get_scores/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ user_id: "{{ user.username }}" })
        });

    let score = await scores.json();
    
    let aptitude_score = score['aptitude'];
    let verbals_score =score['verbals'];
    let software_score = score['software_quiz'];

    document.getElementById("aptitude-score").innerText=aptitude_score;
    document.getElementById("verbals-score").innerText=verbals_score;
    document.getElementById("software-score").innerText=software_score;
}

function displayTables(data, section) {
    const titleMap = {
        software_quiz: "Software Assessments",
        verbals: "Verbals Assessments",
        coding: "Coding Assessments",
        aptitude: "Aptitude Assessments"
    };

    for (const purpose in data) {
        const items = data[purpose];
        if (!Array.isArray(items) || items.length === 0) continue;

        const h3 = document.createElement("h3");
        h3.textContent = titleMap[purpose] ?? purpose;
        section.appendChild(h3);

        const table = document.createElement("table");
        table.className = "activity-table";

        const header = "Assessment ID";

        const tbody = items.map(item => `
            <tr>
                <td>${item.assessment_id || 'N/A'}</td>
            </tr>
        `).join("");

        table.innerHTML = `
            <thead>
                <tr><th>${header}</th></tr>
            </thead>
            <tbody>${tbody}</tbody>
        `;

        section.appendChild(table);
    }
}
</script>

</body>
</html>
